1.
SELECT CLIENT_ID,
	REPORT_DATE,
	(SELECT CCY_RATE
	FROM RATES
	WHERE REPORT_DATE = 
	(SELECT MAX(REPORT_DATE) FROM RATES WHERE REPORT_DATE <= TRANSACTIONS.REPORT_DATE)) * TXN_AMOUNT AS TXN_AMOUNT_USD
FROM TRANSACTIONS

2.

Задание: напишите sql запрос, который для каждого клиента выводит сумму debit, credit операций и последнее посещенное VSP по месяцам. 

WITH GROUPED_DEBIT_CREDIT AS (
	SELECT CLIENT_ID, 
	TO_CHAR(REPORT_DATE, 'YYYY-MM') AS MONTH,
	SUM(TXN_AMOUNT) AS AMOUNT, 
	TXN_TYPE
	FROM VSP_OPER_DATA
	GROUP BY CLIENT_ID, MONTH, TXN_TYPE
), LAST_VSP_NUMBER AS (
	SELECT DISTINCT ON (CLIENT_ID, MONTH) 
	CLIENT_ID,
	TO_CHAR(REPORT_DATE, 'YYYY-MM') AS MONTH,
	VSP_NUMBER
	FROM VSP_OPER_DATA
	ORDER BY CLIENT_ID, MONTH, REPORT_DATE DESC)

SELECT 
DEBIT_CREDIT_AMOUNT.CLIENT_ID,
DEBIT_CREDIT_AMOUNT.REPORT_DATE,
DEBIT_CREDIT_AMOUNT.DEBIT_AMOUNT,
DEBIT_CREDIT_AMOUNT.CREDIT_AMOUNT,
LAST_VSP_NUMBER.VSP_NUMBER AS LAST_VSP
FROM
(SELECT COALESCE(CREDIT_OPER_DATA.CLIENT_ID, DEBIT_OPER_DATA.CLIENT_ID) AS CLIENT_ID,
COALESCE(CREDIT_OPER_DATA.MONTH, DEBIT_OPER_DATA.MONTH) AS REPORT_DATE,
DEBIT_OPER_DATA.AMOUNT AS DEBIT_AMOUNT,
CREDIT_OPER_DATA.AMOUNT AS CREDIT_AMOUNT
FROM
(SELECT * FROM GROUPED_DEBIT_CREDIT WHERE TXN_TYPE = 'credit') AS CREDIT_OPER_DATA
FULL OUTER JOIN 
(SELECT * FROM GROUPED_DEBIT_CREDIT WHERE TXN_TYPE = 'debit') AS DEBIT_OPER_DATA
ON CREDIT_OPER_DATA.CLIENT_ID = DEBIT_OPER_DATA.CLIENT_ID AND CREDIT_OPER_DATA.MONTH = DEBIT_OPER_DATA.MONTH) AS DEBIT_CREDIT_AMOUNT
INNER JOIN
LAST_VSP_NUMBER
ON DEBIT_CREDIT_AMOUNT.CLIENT_ID = LAST_VSP_NUMBER.CLIENT_ID AND DEBIT_CREDIT_AMOUNT.REPORT_DATE = LAST_VSP_NUMBER.MONTH

Задание: напишите sql запрос, который для каждого клиента выведет долю debit операций клиента к debit операциям всех клиентов по месяцам. 

WITH GROUPED_DEBIT AS (
	SELECT CLIENT_ID, 
	TO_CHAR(REPORT_DATE, 'YYYY-MM') AS MONTH,
	SUM(TXN_AMOUNT) AS AMOUNT, 
	TXN_TYPE
	FROM VSP_OPER_DATA
	GROUP BY CLIENT_ID, MONTH, TXN_TYPE
	HAVING TXN_TYPE = 'debit'
)

SELECT CLIENT_ID,
MONTH AS REPORT_DATE,
CAST(AMOUNT AS REAL)/(SELECT SUM(AMOUNT) FROM GROUPED_DEBIT WHERE MONTH = CLIENT_DEBIT.MONTH) AS RATIO
FROM GROUPED_DEBIT CLIENT_DEBIT

3.

WITH DISTANCE AS
(SELECT VSP, VSP_E, VAL, GROUP_VSP FROM DISTANCE_METRIC
UNION
SELECT VSP_E, VSP, VAL, GROUP_VSP FROM DISTANCE_METRIC)

SELECT 
VSP,
MIN(VAL) AS MIN_VAL,
AVG(VAL) AS AVG_VAL,
MAX(VAL) AS MAX_VAL,
GROUP_VSP
FROM DISTANCE
GROUP BY VSP, GROUP_VSP

4.

WITH GROUPS AS
(SELECT DATE_POSITION - (INTERVAL '1 DAY')*ROW_NUMBER() OVER (PARTITION BY USER_ID, USER_POSITION ORDER BY DATE_POSITION) AS GRP,
*
FROM USERS_POSITION)

SELECT USER_ID,
USER_POSITION,
MIN(DATE_POSITION) AS POSITION_START,
MAX(DATE_POSITION) AS POSITION_END
FROM GROUPS
GROUP BY GRP, USER_ID, USER_POSITION
ORDER BY 1, 3 